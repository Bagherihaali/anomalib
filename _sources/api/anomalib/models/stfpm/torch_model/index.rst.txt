:py:mod:`anomalib.models.stfpm.torch_model`
===========================================

.. py:module:: anomalib.models.stfpm.torch_model

.. autoapi-nested-parse::

   PyTorch model for the STFPM model implementation.



Module Contents
---------------

Classes
~~~~~~~

.. autoapisummary::

   anomalib.models.stfpm.torch_model.Loss
   anomalib.models.stfpm.torch_model.STFPMModel




.. py:class:: Loss

   Bases: :py:obj:`torch.nn.Module`

   Feature Pyramid Loss This class implmenents the feature pyramid loss function proposed in STFPM paper.

   .. rubric:: Example

   >>> from anomalib.models.components.feature_extractors.feature_extractor import FeatureExtractor
   >>> from anomalib.models.stfpm.torch_model import Loss
   >>> from torchvision.models import resnet18

   >>> layers = ['layer1', 'layer2', 'layer3']
   >>> teacher_model = FeatureExtractor(model=resnet18(pretrained=True), layers=layers)
   >>> student_model = FeatureExtractor(model=resnet18(pretrained=False), layers=layers)
   >>> loss = Loss()

   >>> inp = torch.rand((4, 3, 256, 256))
   >>> teacher_features = teacher_model(inp)
   >>> student_features = student_model(inp)
   >>> loss(student_features, teacher_features)
       tensor(51.2015, grad_fn=<SumBackward0>)

   .. py:method:: compute_layer_loss(self, teacher_feats: torch.Tensor, student_feats: torch.Tensor) -> torch.Tensor

      Compute layer loss based on Equation (1) in Section 3.2 of the paper.

      :param teacher_feats: Teacher features
      :type teacher_feats: Tensor
      :param student_feats: Student features
      :type student_feats: Tensor

      :returns: L2 distance between teacher and student features.


   .. py:method:: forward(self, teacher_features: Dict[str, torch.Tensor], student_features: Dict[str, torch.Tensor]) -> torch.Tensor

      Compute the overall loss via the weighted average of the layer losses computed by the cosine similarity.

      :param teacher_features: Teacher features
      :type teacher_features: Dict[str, Tensor]
      :param student_features: Student features
      :type student_features: Dict[str, Tensor]

      :returns: Total loss, which is the weighted average of the layer losses.



.. py:class:: STFPMModel(layers: List[str], input_size: Tuple[int, int], backbone: str = 'resnet18')

   Bases: :py:obj:`torch.nn.Module`

   STFPM: Student-Teacher Feature Pyramid Matching for Unsupervised Anomaly Detection.

   :param layers: Layers used for feature extraction
   :type layers: List[str]
   :param input_size: Input size for the model.
   :type input_size: Tuple[int, int]
   :param backbone: Pre-trained model backbone. Defaults to "resnet18".
   :type backbone: str, optional

   .. py:method:: forward(self, images)

      Forward-pass images into the network.

      During the training mode the model extracts the features from the teacher and student networks.
      During the evaluation mode, it returns the predicted anomaly map.

      :param images: Batch of images.
      :type images: Tensor

      :returns: Teacher and student features when in training mode, otherwise the predicted anomaly maps.



